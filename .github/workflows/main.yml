name: SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del codice (con fetch-depth: 0 per la cronologia completa)
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. Setup Java 23 (come richiesto)
      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'
      
      # 3. Caching delle dipendenze Maven per velocizzare le build successive
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      
      # 4. Build e Analisi in un unico passaggio
      # Utilizziamo 'verify' per eseguire anche i test di integrazione prima dell'analisi
      # Il plugin sonar-maven-plugin viene invocato direttamente
      - name: Build and Analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Necessario per scansionare le PR
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    # Il tuo secret configurato su GitHub
        run: >
          mvn -B clean verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
          -Dsonar.organization=yari17
          -Dsonar.projectKey=Yari17_Cardify
          -Dsonar.inclusions=**/*.java
